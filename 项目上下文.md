# 项目上下文 · 与 AI 协作说明

**用途**：新开对话或换设备后，让 AI 先读本文件 + `游戏策划.md`，即可无缝延续开发、记住你的偏好与约定。

---

## 一、项目是什么

- **名称**：塔防 Roguelike
- **双端**：
  - **微信小游戏**：`wechat-mini-game/`，微信开发者工具选「小游戏」打开。
  - **H5 网页版**：`wechat-mini-game-web/`，浏览器打开 `index.html` 或 `python3 -m http.server 8080` 后访问；当前**以 H5 为主开发**，逻辑在 `main.js`，做完可拷回微信版。
- **技术**：Canvas 2D、JS，无引擎
- **核心玩法**：玩家站左侧自动普攻，怪从右向左，击杀升级选技能、凑吞噬与进阶卡池，商店买道具，20 波通关

所有**数值、技能、吞噬、进阶卡池、商店、波次、存档**等规则，以 **`游戏策划.md`** 为准；改规则时请同步更新该文档。

---

## 二、你的偏好与约定（请按需增删）

- **语言**：与 AI 沟通用中文。
- **记录**：重要游戏机制、策划规则写在 `游戏策划.md`，便于长期一致、换对话也记得住。
- **进度记录**：每次做完功能或较大更新后，由 AI 把「做了什么」写进本文件「四、当前进度」，**做完就记录**，方便新对话接着干。
- **延续性**：希望不管什么时候和 AI 说话，都能记得之前说过的话；因此用本文件 + `游戏策划.md` 做「持久记忆」，新对话开头让 AI 先读这两份文件即可无缝继续。
- **编译/运行**：本小游戏在微信开发者工具里直接打开项目即可预览，无单独编译命令；若你之后接入了构建脚本，可在此补充「重新构建命令」。
- **节奏**：先做机制、再做表现（音效/引导等）；分享功能你说先不做。

---

## 三、新对话时怎么「唤醒」AI（推荐）

在新对话的**第一条消息**里可以这样说（或按你习惯改）：

- 「请先阅读 `项目上下文.md` 和 `游戏策划.md`，然后我们继续做 xxx。」
- 或：「先读一下项目里的 项目上下文 和 游戏策划，再接着帮我 xxx。」

这样 AI 会先加载这两份文件，自动恢复：项目是什么、规则是什么、你的偏好是什么，然后按你当前需求继续，实现「无缝」协作。需要了解「上次做到哪了」时，可看本文件「四、当前进度」。

---

## 四、当前进度 / 最近在做的事

（**做完更新就由 AI 写在这里**，方便新对话接着干。）

- **已完成**：
  - 技能系统：基础 12 张 + 5 套装 + 每套装独立进阶卡池；栏位满时可选新技能替换旧技能；选技能可刷新，跳过获得 1 次刷新机会。
  - H5 网页版：`wechat-mini-game-web/`，adapter 适配 wx API，`main.js` 与微信版共用，存档用 localStorage。
  - UI：深色主题 + 琥珀强调、圆角；波次在上半部分顶部居中；资源（金币、击杀）+ 商店在右侧；技能栏 7 格 + 装备栏 3 格；等级/经验条在上半部分底部（Lv.x 居中在条内）；角色属性框在下面，不盖住商店。
  - 装备系统：10 件装备、装备栏 6 格；小怪击杀 1% 概率随机掉落**可掉落**装备，满格时弹出「选择替换」；狂暴战开局自动装备**狂暴战刃**（id 9，+50 攻击、怒气获取 +30%，不可掉落）；装备支持 attackFlat、rageGainPct、droppable；存档含 equipment_slots、playerAttackFlat 等。
  - 属性与英雄：三属性力量/敏捷/智力；大类型+职业；主属性→攻击、力量→生命、敏捷→攻速；升级按职业成长加属性并重算生命上限。**副属性**暴击（数值→暴击率，暴击 200% 伤害）、极速（数值→攻速与 CD 缩短，100 极速=攻速/CD 速率翻倍）；UI 显示力/敏/智、暴击(率)、极速；存档含 heroType、heroClass、playerCrit、playerHaste。
  - **怒气机制**（仅战士职业，如狂暴战；CLASSES 中 hasRage: true）：上限 100；**仅普攻**命中 +5、暴击 +5，**嗜血**释放额外 +10；旋风斩/顺劈不加怒气；当前不受击加怒气（可留 RAGE_PER_HIT_TAKEN 给后续战士）；属性框显示怒气条；存档含 playerRage。
  - **主动技能·暴怒**（id 16），狂暴战前三次升级之一必出：伤害=（力量×10+攻击力）×280%，消耗 100 怒气，无 CD，怒气够且有目标自动释放；可触发顺劈；技能栏显示怒气不足/就绪。
  - **伤害统计**：按类型累计（普攻/嗜血/旋风斩/顺劈/暴怒）于 damageByType；右侧资源区显示总伤害及按伤害从高到低排序的各类占比；游戏结束/通关界面同样展示总伤害与分类排序；存档含 damageByType。
  - 主动技能·嗜血：已加入技能池（id 12），狂暴战**前三次升级之一必出**；造成 150% 伤害并回复造成伤害的 20% 生命，随后 3 秒攻速×1.2，CD 4 秒自动释放；技能栏显示 CD/就绪/攻速+；存档含 CD 与 buff 剩余时间。
  - 主动技能·旋风斩：已加入技能池（id 15），狂暴战**前三次升级之一必出**；对最多 5 个敌人各造成 80% 伤害（可暴击），CD 5 秒自动释放；使用后 5s 内**顺劈**：嗜血/暴怒对主目标造成伤害时主目标外最多 4 单位受 60% 顺劈伤害；技能栏显示 CD/就绪/顺劈；存档含 skillXuanFengCd、skillShunpiBuff。
  - 暴击/极速底层为数值：暴击率=暴击/(暴击+100)，1 极速=效果+1%。暴击专精（id 13）、极速专精（id 14）可通过升级 3 选 1 获得。
  - **开局三技能机制**：嗜血、旋风斩、暴怒不再开局自带；新游戏技能栏为空，前三次升级的 3 选 1 仅从这三张中抽取，抽满三张后从全技能池正常抽取。
  - 暴击视觉反馈：`applyCrit` 改为返回 `{ damage, isCrit }`；普攻与嗜血暴击时在目标位置显示「暴击！」金色描边飘字（约 0.6 秒淡出），攻速再快也能直观看到是否暴击。
  - **技能名喊话**：释放嗜血/旋风斩/暴怒时，玩家头顶短暂显示对应技能名（如「嗜血！」）并上飘淡出；多技能同帧释放时多条文字垂直错开（stackIndex），不叠在一起。
  - **首次打开与标题**：每次打开游戏先进入标题界面；无存档时只显示「开始游戏」，有存档时显示「新游戏」「继续游戏」。点「开始游戏」或「新游戏」会正确执行 `resetGame()`，初始化空技能栏与伤害统计，前三次升级仅从嗜血/旋风斩/暴怒中抽取。
  - **H5 在线 Demo**：已用 GitHub Pages 发布，在线试玩与推送步骤见本文件「七、GitHub 使用备忘」。
  - **吞噬功能完善**：UI 统一用「吞噬」一词（不再用「套装」）。选技能界面为「吞噬收集情况」，已激活项显示「xxx ✓（技能A、技能B 已吞噬）」并说明「激活后，组成技能不占栏位，效果保留」；下方面板为「吞噬效果」区，技能栏在存在已吞噬时显示「（已吞噬不占位）」；每个已激活吞噬下列出「已吞噬 技能A、技能B，不占栏位」。技能卡上「可激活吞噬：xx」。**旋风斩专属吞噬**：新增**击杀怪数**（monsterKillCount，仅战斗中击杀怪物时+1，与杀敌数 killCount 区分）；击杀怪数≥50 时旋风斩被吞噬（不占栏位），技能栏内显示「50击杀 x/50」，吞噬效果区显示「旋风斩：50击杀已吞噬」；存档含 monsterKillCount。**暴怒专属吞噬**：新增**累计消耗怒气**（rageConsumedTotal，每次释放暴怒 +100）；累计消耗≥500 时暴怒被吞噬（不占栏位），技能栏内显示「500怒气 x/500」，吞噬效果区显示「暴怒：500怒气已吞噬」；存档含 rageConsumedTotal。**吞噬/套装加攻速改为加极速**：刺客、迅捷、破势、均衡之道的原「攻速+%」效果改为「极速+数值」（极速同时加成攻速与 CD），战士仍为纯攻击+20%。
  - 项目上下文约定：做完更新就记录到本文件「四、当前进度」。
- **后续可做**：装备扩展（商店购买/Boss 掉落）、音效、新手引导、平衡、成就/统计、设置等（见 `游戏策划.md` 末尾）。

---

## 五、历史重要决定 / 你说过的重要点

（有新的重要决定或你特别强调的点，可随时追加到下面，新对话时 AI 读到这里就会记住。）

- **进阶卡池**：不是「激活任意一个吞噬就开一个通用进阶池」，而是**每个基础吞噬各自对应一个独立进阶卡池**；只有激活该吞噬后，该吞噬的进阶卡才会进入 3 选 1。
- **分享**：先不做分享功能，以后要做再说。
- **核心诉求**：希望不管什么时候和 AI 说话，都能记得之前说过的话；重要内容记录在文档里，新对话先读文档即可无缝继续。
- **wasm 网页版**（若你还在维护）：在 `~/Desktop/wasm-game/`，每次改完 C 代码需要重新编译；你希望每次结束后 AI 给一条「重新编译的命令」，可用该目录下的 `build.sh` 或 进度.md 里的完整 emcc 命令。
- **进度记录**：每次做完功能或较大更新后，AI 要**主动**把「做了什么」写进本文件「四、当前进度」，做完就记，不依赖用户提醒。
- **H5 与微信**：以 H5 为主开发；要同步到微信时，把 `wechat-mini-game-web/js/main.js` 拷到 `wechat-mini-game/js/main.js` 即可。
- **小游戏目录可删**：若当前只在 H5 开发，可先删掉 `wechat-mini-game/`；需要上小游戏时按下面「六、恢复微信小游戏」重新建即可。

---

## 六、恢复微信小游戏（若已删除小游戏目录）

需要重新发布微信小游戏时，在**桌面**（或你放 H5 项目的同级目录）按下面做一遍即可。

1. **新建目录**  
   `wechat-mini-game/`，并在其下建子目录 `js/`。

2. **新建并写入以下 3 个文件**

   - **game.js**（小游戏入口，放在 `wechat-mini-game/` 根目录）：
     ```js
     // 小游戏入口：创建画布并启动游戏循环
     import './js/main.js'
     ```
   - **game.json**（放在 `wechat-mini-game/` 根目录）：
     ```json
     {"deviceOrientation":"portrait","showStatusBar":false}
     ```
   - **project.config.json**（放在 `wechat-mini-game/` 根目录）：
     ```json
     {"description":"塔防小游戏项目","packOptions":{"ignore":[]},"setting":{"urlCheck":true,"es6":true,"enhance":true,"postcss":true,"minified":true},"compileType":"minigame","libVersion":"3.5.0","appid":"touristappid","projectname":"wechat-mini-game","condition":{}}
     ```

3. **拷贝主逻辑**  
   将 `wechat-mini-game-web/js/main.js` 复制到 `wechat-mini-game/js/main.js`。

4. **用微信开发者工具打开**  
   选择「小游戏」→ 打开目录 `wechat-mini-game` 即可预览。  
   （若工具自动生成 `project.private.config.json`，保留即可，无需手写。）

---

## 七、GitHub 使用备忘（H5 Demo 发布）

本项目的 H5 已用 **GitHub Pages** 发布，方便别人在线试玩。关键信息记在这里，以后忘了可以翻。

- **GitHub 用户名**：`tiamyou1996-glitch`（终端里问的 Username 就填这个）
- **本仓库地址**：`https://github.com/tiamyou1996-glitch/td-roguelike`
- **在线试玩地址**：`https://tiamyou1996-glitch.github.io/td-roguelike/`

**推送代码到 GitHub：**

1. 在项目目录执行：`git add .` → `git commit -m "说明"` → `git push -u origin main`
2. 若提示输入：
   - **Username**：填 `tiamyou1996-glitch`
   - **Password**：填 **Personal Access Token**（不是 GitHub 登录密码）
3. Token 在 GitHub 网页：右上角头像 → **Settings** → 左侧最下 **Developer settings** → **Personal access tokens** → **Tokens (classic)** → 可生成新 Token 或查看已有。生成时勾选 **repo** 权限。
4. **安全提醒**：Token 相当于密码，请保存在本机或密码管理器里，**不要写进项目里的任何文件并提交到 Git**，否则会泄露。

**更新在线 Demo：** 改完代码后执行 `git add .` → `git commit -m "更新说明"` → `git push`，等一两分钟 Pages 会自动更新。

**若连不上 GitHub（如 443 超时）：** 若本机开了代理，给 Git 配代理后再 push，例如（端口改成你的代理端口）：  
`git config --global http.https://github.com.proxy http://127.0.0.1:7897`  
`git config --global https://github.com.proxy https://127.0.0.1:7897`

---

*本文件由你与 AI 共同维护，有新的约定或重要点可随时加在上面，新对话时先读即可记住。*
