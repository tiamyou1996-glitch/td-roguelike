# 项目上下文 · 与 AI 协作说明

**用途**：新开对话或换设备后，让 AI 先读本文件 + `游戏策划.md`，即可无缝延续开发、记住你的偏好与约定。

---

## 一、项目是什么

- **名称**：塔防 Roguelike
- **双端**：
  - **微信小游戏**：`wechat-mini-game/`，微信开发者工具选「小游戏」打开。
  - **H5 网页版**：`wechat-mini-game-web/`，浏览器打开 `index.html` 或 `python3 -m http.server 8080` 后访问；当前**以 H5 为主开发**，逻辑在 `main.js`，做完可拷回微信版。
- **技术**：Canvas 2D、JS，无引擎
- **核心玩法**：玩家站左侧自动普攻，怪从右向左，击杀升级选技能、凑吞噬与进阶卡池，商店买道具，20 波通关

所有**数值、技能、吞噬、进阶卡池、商店、波次、存档**等规则，以 **`游戏策划.md`** 为准；改规则时请同步更新该文档。

---

## 二、你的偏好与约定（请按需增删）

- **语言**：与 AI 沟通用中文。
- **记录**：重要游戏机制、策划规则写在 `游戏策划.md`，便于长期一致、换对话也记得住。
- **进度记录**：每次做完功能或较大更新后，由 AI 把「做了什么」写进本文件「四、当前进度」，**做完就记录**，方便新对话接着干。
- **延续性**：希望不管什么时候和 AI 说话，都能记得之前说过的话；因此用本文件 + `游戏策划.md` 做「持久记忆」，新对话开头让 AI 先读这两份文件即可无缝继续。
- **编译/运行**：本小游戏在微信开发者工具里直接打开项目即可预览，无单独编译命令；若你之后接入了构建脚本，可在此补充「重新构建命令」。
- **节奏**：先做机制、再做表现（音效/引导等）；分享功能你说先不做。

---

## 三、新对话时怎么「唤醒」AI（推荐）

在新对话的**第一条消息**里可以这样说（或按你习惯改）：

- 「请先阅读 `项目上下文.md` 和 `游戏策划.md`，然后我们继续做 xxx。」
- 或：「先读一下项目里的 项目上下文 和 游戏策划，再接着帮我 xxx。」

这样 AI 会先加载这两份文件，自动恢复：项目是什么、规则是什么、你的偏好是什么，然后按你当前需求继续，实现「无缝」协作。需要了解「上次做到哪了」时，可看本文件「四、当前进度」。

---

## 四、当前进度 / 最近在做的事

（**做完更新就由 AI 写在这里**，方便新对话接着干。）

- **已完成**：
  - **技能系统重构（阶段一+二）**：旧技能数据已全部删除（原 SKILL_POOL 17 张、SYNERGIES 5 个、ADVANCED_POOLS 10 张不再使用）。新表已接入：**ALL_SKILLS**（41 条，id 0～40，与 `技能整理 - Sheet1.csv` 对应）、**SYNERGY_DEFS**（13 个吞噬）、**ADVANCED_POOLS**（按前置解锁的进阶池）。**小池子**：开局升级 3 选 1 仅从**初始 3 张**（id 0,1,2：狂暴姿态、激怒状态、双武器）中抽，集齐后才开放**基础 5 张**（id 3～7：嗜血、怒击、暴怒、旋风斩、斩杀）与满足前置的进阶池。**进阶池**：按「学了某技能」或「某吞噬已激活」解锁（如学斩杀后出现斩杀进阶池，吞噬怒击组后出现怒击2 进阶池）。战斗与 UI 已改用新 id（嗜血=3、怒击=4、暴怒=5、旋风斩=6、斩杀=7）；暴怒/旋风斩专属吞噬（500 怒气、50 击杀）已保留。选技能可刷新，跳过获得 1 次刷新机会；栏位满时可替换已有技能。
  - H5 网页版：`wechat-mini-game-web/`，adapter 适配 wx API，`main.js` 与微信版共用，存档用 localStorage。
  - UI：深色主题 + 琥珀强调、圆角；波次在上半部分顶部居中；资源（金币、击杀）+ 商店在右侧；技能栏 7 格 + 装备栏 6 格；等级/经验条在上半部分底部（Lv.x 居中在条内）；角色属性框在下面，不盖住商店。
  - 装备系统：10 件装备、装备栏 6 格；小怪击杀 1% 概率随机掉落**可掉落**装备，满格时弹出「选择替换」；狂暴战开局自动装备**狂暴战刃**（id 9，+50 攻击、怒气获取 +30%，不可掉落）；装备支持 attackFlat、rageGainPct、droppable；存档含 equipment_slots、playerAttackFlat 等。
  - 属性与英雄：四维**力量/敏捷/智力/耐力**；大类型+职业；主属性→攻击（力量仅做主属性，不参与生命）；**生命由耐力决定**（基础生命 = 200 + 耐力×40）；升级按职业成长加属性并按耐力重算生命上限。**副属性**暴击、极速、精通、吸血；UI 见下「属性/吞噬/伤害统计按钮」。存档含 heroType、heroClass、playerStr/playerSta、playerCrit、playerHaste 等。
  - **怒气机制**（仅战士职业）：上限 100；普攻命中 +5、暴击 +5；嗜血释放 +8（新表）；旋风斩/顺劈不加怒气。属性框显示怒气条；存档含 playerRage。
  - **伤害统计**：按类型累计（普攻/嗜血/怒击/旋风斩/顺劈/暴怒/暴怒毁灭/斩杀/奥丁之怒/流血）于 damageByType；**伤害统计**为面板底部按钮，点击后弹层展示总伤害及各类占比；存档含 damageByType。
  - 暴击视觉反馈：普攻与嗜血暴击时在目标位置显示「暴击！」飘字；释放嗜血/旋风斩/暴怒时玩家头顶显示技能名并上飘淡出。
  - **首次打开与标题**：每次打开游戏先进入标题界面；无存档时只显示「开始游戏」，有存档时显示「新游戏」「继续游戏」。点「开始游戏」或「新游戏」执行 `resetGame()`，技能栏为空，升级先抽初始 3 张再开放基础与进阶池。
  - **H5 在线 Demo**：已用 GitHub Pages 发布，在线试玩与推送步骤见本文件「七、GitHub 使用备忘」。
  - 项目上下文约定：做完更新就记录到本文件「四、当前进度」。
- **已完成（阶段三+四）**：**所有吞噬类型的状态与判断**。① **获得即吞噬**：狂怒回复(33)、狂怒提振(34)、生死决战(35) 选到即视为已吞噬、不占栏位，效果保留。② **60 秒战斗时间吞噬**：旋风斩/斩杀/重伤/奥丁之怒(6,7,26,40)，从学到该技能起仅累计战斗内时间（选技能/商店/波次间隔不计），满 60 秒吞噬；学到时记录 `skillCombatTimeLearnedAt`，每帧在 `waveBreakCountdown<=0` 时 `combatTimeSeconds += dt`。③ **累计获得怒气吞噬**：鲁莽(24) 选后累计获得 500 怒气吞噬、肆意放纵(25) 选后累计获得 1000 怒气吞噬；`addRage` 时累加 `skillRageGainedSinceLearned[24/25]`。④ **激怒状态与激怒时间 20 秒吞噬**：嗜血 30% 进入激怒 4 秒、暴怒进入激怒 4 秒，`enrageBuffRemaining`/`enrageTimeTotal` 每帧更新；狂乱之怒等(28~32) 学到后处于激怒的累计时间达 20 秒吞噬，`skillEnrageTimeLearnedAt` 记录学到时激怒累计。⑤ **累计流血 10000 吞噬**：浴血之躯(27) 的 `totalBleedDamage >= 10000` 即吞噬（实际流血伤害后续接重伤/流血机制）。⑥ 统一 `isSkillConsumedBySynergy` 与 `getSynergyProgressForSkill`，存档含 combatTimeSeconds、skillCombatTimeLearnedAt、rageGainedTotal、skillRageGainedSinceLearned、enrageTimeTotal、skillEnrageTimeLearnedAt、totalBleedDamage；吞噬展示区显示「其他已吞噬」列表。
- **已完成（阶段五+六）**：**新机制接入战斗、技能效果接新表**。① **精通**：`playerMastery`，最终伤害乘 (1+精通%)；**吸血**：`playerLifesteal`，造成伤害按比例回血；**激怒状态**（技能 1）：激怒时精通+15%、吸血+3%（含在 getEffectiveMastery/getEffectiveLifesteal）。② 所有伤害点（普攻、嗜血、旋风斩、暴怒、顺劈）统一：暴击 → applyMastery → 扣目标血 → applyLifestealHeal。③ **暴击**：敌意(18) 暴击伤害+8%、暴虐成性(22) 怒击暴击率+10% 暴击伤害+10%，applyCrit(damage, forNuJi)。④ **技能倍率接新表**：getXueDamageMul(target)（血腥疯狂15、敌意18、恶毒瞥视16<50%血、血之气息36、残酷32激怒）、getXuanFengDamageMul()（血肉顺劈12 +50%）、getBaoNuDamageMul()（血之气息36、处决者37）；嗜血回复 寒光热血(14) +10%、怒气 +4，嗜血激怒几率 新鲜血肉(13) 翻倍。⑤ 属性框显示精通/吸血（激怒状态学会后显示）。
- **已完成（阶段七+八）**：① **重伤/流血**：学会重伤(26) 后，嗜血/暴怒/旋风斩等命中会给目标施加 wound（6 秒内造成该次伤害 50% 的流血，每 0.2 秒跳一次）；刷新时剩余伤害并入新 wound。每帧 tickWound：按剩余时间比例扣血、累加 totalBleedDamage、触发吸血与击杀逻辑；浴血之躯(27) 使流血伤害 ×1.2。敌人存档含 wound。② **鲁莽主动**：学会鲁莽(24) 后右侧显示「鲁莽」按钮，CD 90 秒、持续 12 秒；持续期间怒气获得 ×1.5、暴击率 +20%；肆意放纵(25) 下使用鲁莽立即 +50 怒气、持续期间嗜血/怒击伤害 +20%。skillLumangCd、recklessBuffRemaining 存档。③ **生死决战**：学会(35) 后首次死亡时复活至 50% 最大生命、一局一次，deathReviveUsed 存档。④ **战争印记(31)**：激怒时受到伤害降低 10%。
- **已完成**：**怒击、斩杀接入战斗**。① **怒击(id=4)**：主动 130% 伤害、+12 怒气、7s CD，受 getNuJiDamageMul/暴虐成性/劈斩/蛮力爆发 等影响；嗜血/暴怒 25% 重置怒击 CD（劈斩）；怒击 25% 重置自身 CD 并触发蛮力爆发 3 秒（强化怒击/蛮力爆发）。② **斩杀(id=7)**：普攻时 20% 概率触发（猝死 +10%）、200% 伤害（猝死 +50%、毁灭 ×2）、5s CD（毁灭 -1.5s）；强化斩杀 +20 怒气、处决者 +5 怒气；伤害统计含「怒击」「斩杀」。
- **已完成（新技能全部接入）**：① **暴怒毁灭(38)**：暴怒对攻击范围内最多 5 个目标额外造成 80% 暴怒基础伤害（含主目标）。② **狂乱(39)**：暴怒后极速 +2% 每层、持续 12 秒可叠层、持续时间不刷新；kuangLuanHasteStacks/kuangLuanBuffRemaining 每帧衰减，getEffectiveHaste 计入。③ **狂乱之怒(28)**：激怒时极速 +15%，getEffectiveHaste 中接入。④ **狂怒回复(33)/狂怒提振(34)**：生命 ≤30%（学 34 后 ≤50%）时嗜血回复 +20%，castSkillXue 中按 hpPct 与阈值加成 healPct。⑤ **奥丁之怒(40)**：主动技能，30s CD（受极速影响），右侧「奥丁之怒」按钮；释放时对范围内最多 5 个敌人造成 200% 攻击力伤害、施加 200% 攻击力流血（6 秒内每 0.2s 跳）、+20 怒气、进入激怒 4 秒；技能栏显示 CD/就绪；ALL_SKILLS[40] 为 isActive: true。存档含 kuangLuanHasteStacks、kuangLuanBuffRemaining、skillOdinCd。
- **已完成（主动挑战）**：界面「挑战 第N层」按钮（N 为已挑战层数+1，进行中显示「剩余 Xs」）；点击后在**屏幕正中央**生成挑战 Boss（30 秒限时），第 1 层血量=第 5 波 Boss 的 50%、攻击力同普通 Boss，之后每层**血量与攻击力均翻倍**；超时失败可重试，击杀成功可再次挑战；存档含 challengeCount、challengeTimer、敌人 isChallengeBoss。
- **已完成（UI 与数值调整）**：① **双武器(2)**：普攻同时攻击 2 个目标、攻速降低 20%，保留伤害+10%。② **重伤**：流血 = 造成该次伤害的 50%（6 秒内每 0.2 秒跳一次），刷新时剩余伤害并入；**流血**单独计入伤害统计。③ 波次间隔 3 秒、同波出怪间隔 1 秒、小怪基础血量 100。④ **生命由耐力决定**（HP_BASE + 耐力×HP_PER_STA），力量仅作力量系主属性；职业表增加 baseSta/staPerLevel。⑤ **吞噬效果**、**属性**均改为**按钮 + 弹层**（与伤害统计一致）：面板底部「吞噬效果」「伤害统计」按钮，装备栏下「属性」按钮；点击后弹层展示，互斥打开。⑥ 属性弹层内两列：左列生命值/攻击力/攻速/攻击间隔（及永久加成），右列力量/敏捷/智力/耐力、暴击（显示为「x%(数值）」）、极速、精通、吸血、怒气、职业；文案完整（如「力量」「耐力」）。
- **已完成（底部 TAB + 抽屉）**：界面底部新增 **TAB 栏**（挑战、属性、伤害统计、吞噬效果、**商店**）共 5 个；点击 TAB 后从屏幕下方**升起抽屉**展示内容。挑战/属性/伤害统计/吞噬效果/商店均为抽屉内容；抽屉高度不超过面板内容区，触摸仅在实际抽屉区域内吞掉事件，避免点不到技能栏。技能栏「（已吞噬不占位）」等文字做裁剪防溢出。
- **已完成（商店与打磨武器）**：商店仅保留 **生命药水**（15 金，恢复 15% 最大生命）与 **打磨武器**（动态价格：底价 10 金，每次购买后下次价格 ×1.3；每次购买武器属性 +20%，即 strBonus/staBonus/attackFlat 均乘 weaponForgedMul，在 getEquipmentStrBonus/getEquipmentStaBonus/getEquipmentAttackFlat 中乘算）。打磨后若耐力变化会重算 playerMaxHp。装备栏显示打磨后数值；新增武器属性时需同步在打磨逻辑中支持（见「武器属性与打磨/升级」）。
- **已完成（怪物血量与挑战奖励）**：小怪血量采用**混合公式**：1～15 波为指数 15×1.37^(wave-1)，16～20 波线性过渡到第 20 波 5000 血，避免后期起飞。**挑战成功**奖励金币：第 1 次 20 金，之后每次 ×1.5（第 2 次 30、第 3 次 45…）。
- **已完成（吞噬与 UI 细节）**：旋风斩「50 击杀」吞噬改为**选到该技能之后**才开始计数（skillMonsterKillSinceLearned），存档与重置已接。角色属性面板生命值/力量/耐力等取整显示。**血条**：玩家血条与怒气条固定到游戏区顶部，怪物/Boss 重叠时血条按重叠数量垂直错开显示。**伤害统计**抽屉内容过多时可上下拖动滚动（touchStart/touchMove 已接，adapter 支持 onTouchStart/onTouchMove）。
- **已完成（音效与获得武器提示）**：音效使用 **Web Audio API 程序化生成**（hit/kill/levelup/buy/hurt），无需外部文件即可播放；也可在 audio/ 下放 mp3 后扩展为文件播放。**集齐 3 个初始技能**触发双持狂战士吞噬并发放「两把双手剑」时，显示**获得武器提示**：约 1.8 秒动画，先中央弹窗「你获得了一把新武器！」+ 武器名，再缩小飞入下方装备栏第一格位置。
- **进行中**：无。
- **后续可做**：新手引导、平衡、成就/统计、设置（音效开关）、分享等（见 `游戏策划.md` 末尾）。

---

## 五、历史重要决定 / 你说过的重要点

（有新的重要决定或你特别强调的点，可随时追加到下面，新对话时 AI 读到这里就会记住。）

- **进阶池**：按**前置条件**解锁（学了某技能或吞噬某组后，对应进阶池才进入 3 选 1）；与「每吞噬独立进阶池」不同，现为「每池绑定前置技能/吞噬」。
- **分享**：先不做分享功能，以后要做再说。
- **核心诉求**：希望不管什么时候和 AI 说话，都能记得之前说过的话；重要内容记录在文档里，新对话先读文档即可无缝继续。
- **wasm 网页版**（若你还在维护）：在 `~/Desktop/wasm-game/`，每次改完 C 代码需要重新编译；你希望每次结束后 AI 给一条「重新编译的命令」，可用该目录下的 `build.sh` 或 进度.md 里的完整 emcc 命令。
- **进度记录**：每次做完功能或较大更新后，AI 要**主动**把「做了什么」写进本文件「四、当前进度」，做完就记，不依赖用户提醒。
- **H5 与微信**：以 H5 为主开发；要同步到微信时，把 `wechat-mini-game-web/js/main.js` 拷到 `wechat-mini-game/js/main.js` 即可。
- **小游戏目录可删**：若当前只在 H5 开发，可先删掉 `wechat-mini-game/`；需要上小游戏时按下面「六、恢复微信小游戏」重新建即可。
- **技能重构**：之前做的技能（强力一击、锋芒、刺客/战士/迅捷/破势/均衡之道及对应进阶等）**全部删掉**，不保留；用新表（技能整理）完全替换。

### 技能重构碰头结论（与策划对齐，改代码时以此为准）

- **技能来源**：以 `技能整理 - Sheet1.csv`（及后续你提供的同表更新）为准；职业当前为狂暴战专版。
- **小池子**：**初始 3 张**（狂暴姿态、激怒状态、双武器）开局时升级 3 选 1 只从这 3 张抽，**集齐这 3 张之后**才开放**基础 5 张**（嗜血、怒击、暴怒、旋风斩、斩杀）进入抽卡池；之后再与各类进阶池一起参与 3 选 1。
- **60 秒后自动吞噬**：从**学到该技能**开始算，**仅战斗时间**（怪物在动、玩家在打的时间），选技能/商店/波次间隔/暂停不计；满 60 秒该技能自动吞噬（不占栏位）。
- **鲁莽 / 肆意放纵**：**选到鲁莽之后**累计**获得**的怒气达到 **500** 则鲁莽吞噬；**选到肆意放纵之后**累计**获得**的怒气达到 **1000** 则肆意放纵吞噬；与暴怒的「累计消耗怒气」分开统计。
- **狂乱之怒等「激怒时间 20 秒」**：获得该技能后，角色**处于激怒状态的累计时间**达到 20 秒则该技能吞噬；统计「激怒 buff 存在时的累计时长」。
- **精通**：1% 精通 = 1% 伤害提升（最终伤害乘 (1 + 精通%)）。
- **吸血**：全局吸血，所有造成的伤害按一定比例回血（如 3% 吸血 = 造成 100 伤害回 3 血）。
- **雷霆一击**：新技能，当前不做，后续补充；血肉顺劈先只做「旋风斩伤害提高 50%」。
- **熟能生巧**：先不做，不加入当前技能池。
- **进阶池与前置**：进阶池按**前置条件**解锁，与「对应技能」绑定。例如：只有**学了斩杀**才看得到斩杀进阶池（猝死、强化斩杀、毁灭）；只有**学了怒击**才看得到怒击进阶池；**吞噬了怒击那一组**才看得到怒击 2 进阶池。未满足前置的进阶池不会进入 3 选 1。

### 武器属性与打磨/升级（务必遵守）

- **武器的属性**：在 `EQUIPMENT_DEFS` 里每件装备可能有 **strBonus（力量）、staBonus（耐力）、attackFlat（攻击）**，以及以后你加的新武器可能有的 **agiBonus、intBonus** 等。这些都属于「武器提供的属性」。
- **打磨武器 / 升级武器**：凡是这类「按比例提升武器属性」的功能，必须对**上述所有属性**都生效，不能只做其中几项。
- **实现约定**：
  1. 所有「从装备读出的属性」都要在**读取时**乘上 `weaponForgedMul`（例如 `getEquipmentStrBonus`、`getEquipmentStaBonus`、`getEquipmentAttackFlat`）；以后若新增 `agiBonus`/`intBonus`，也要有对应的 `getEquipmentXxxBonus()` 并在其中乘 `weaponForgedMul`。
  2. 装备栏/属性面板里显示武器加成时，要显示**打磨后的数值**（即 基础值 × weaponForgedMul），不要只显示 EQUIPMENT_DEFS 里的原始值。
  3. 打磨后若**耐力**变化（装备有 staBonus），必须按 `getBaseMaxHpFromSta()` 重算并更新 `playerMaxHp`、并 cap `playerHp`；若以后有其它属性影响生命/攻击等，也要在购买打磨后同步更新对应派生数值。
- 新增武器时：在 `EQUIPMENT_DEFS` 里写好该武器的**所有**属性字段；在实现打磨/升级时检查一遍，确保每个属性都有对应的 getter 且 getter 里乘了 `weaponForgedMul`，避免漏掉。

---

## 六、恢复微信小游戏（若已删除小游戏目录）

需要重新发布微信小游戏时，在**桌面**（或你放 H5 项目的同级目录）按下面做一遍即可。

1. **新建目录**  
   `wechat-mini-game/`，并在其下建子目录 `js/`。

2. **新建并写入以下 3 个文件**

   - **game.js**（小游戏入口，放在 `wechat-mini-game/` 根目录）：
     ```js
     // 小游戏入口：创建画布并启动游戏循环
     import './js/main.js'
     ```
   - **game.json**（放在 `wechat-mini-game/` 根目录）：
     ```json
     {"deviceOrientation":"portrait","showStatusBar":false}
     ```
   - **project.config.json**（放在 `wechat-mini-game/` 根目录）：
     ```json
     {"description":"塔防小游戏项目","packOptions":{"ignore":[]},"setting":{"urlCheck":true,"es6":true,"enhance":true,"postcss":true,"minified":true},"compileType":"minigame","libVersion":"3.5.0","appid":"touristappid","projectname":"wechat-mini-game","condition":{}}
     ```

3. **拷贝主逻辑**  
   将 `wechat-mini-game-web/js/main.js` 复制到 `wechat-mini-game/js/main.js`。

4. **用微信开发者工具打开**  
   选择「小游戏」→ 打开目录 `wechat-mini-game` 即可预览。  
   （若工具自动生成 `project.private.config.json`，保留即可，无需手写。）

---

## 七、GitHub 使用备忘（H5 Demo 发布）

本项目的 H5 已用 **GitHub Pages** 发布，方便别人在线试玩。关键信息记在这里，以后忘了可以翻。

- **GitHub 用户名**：`tiamyou1996-glitch`（终端里问的 Username 就填这个）
- **本仓库地址**：`https://github.com/tiamyou1996-glitch/td-roguelike`
- **在线试玩地址**：`https://tiamyou1996-glitch.github.io/td-roguelike/`

**推送代码到 GitHub：**

1. 在项目目录执行：`git add .` → `git commit -m "说明"` → `git push -u origin main`
2. 若提示输入：
   - **Username**：填 `tiamyou1996-glitch`
   - **Password**：填 **Personal Access Token**（不是 GitHub 登录密码）
3. Token 在 GitHub 网页：右上角头像 → **Settings** → 左侧最下 **Developer settings** → **Personal access tokens** → **Tokens (classic)** → 可生成新 Token 或查看已有。生成时勾选 **repo** 权限。
4. **安全提醒**：Token 相当于密码，请保存在本机或密码管理器里，**不要写进项目里的任何文件并提交到 Git**，否则会泄露。

**更新在线 Demo：** 改完代码后执行 `git add .` → `git commit -m "更新说明"` → `git push`，等一两分钟 Pages 会自动更新。

**若连不上 GitHub（如 443 超时）：** 若本机开了代理，给 Git 配代理后再 push，例如（端口改成你的代理端口）：  
`git config --global http.https://github.com.proxy http://127.0.0.1:7897`  
`git config --global https://github.com.proxy https://127.0.0.1:7897`

---

*本文件由你与 AI 共同维护，有新的约定或重要点可随时加在上面，新对话时先读即可记住。*
