# 塔防 Roguelike · 游戏策划与规则说明

本文档记录当前版本的核心规则与系统，便于后续扩展与交接。  
**与 AI 协作时**：新对话请先让 AI 阅读本文件与 `项目上下文.md`，以便无缝延续并记住你的约定。

---

## 一、核心玩法

- **类型**：塔防 + Roguelike，单角色站桩输出。
- **目标**：玩家站在左侧，右侧不断刷怪向左移动；玩家在攻击范围内自动普攻，击杀获得经验与金币，升级选技能，撑过 20 波并存活即通关。
- **失败**：玩家生命归零即游戏结束。

---

## 二、战斗与数值

### 2.1 玩家

- **位置**：固定于画面左侧（x=50），垂直居中于游戏区。
- **属性与英雄类型**：
  - 三种属性：**力量**、**敏捷**、**智力**。英雄**大类型**分为力量英雄、敏捷英雄、智力英雄；每个大类型下可有多个**职业**（如力量英雄下有「狂暴战」），职业决定初始属性与**升级成长**。
  - **主属性**决定攻击力：力量英雄看力量、敏捷英雄看敏捷、智力英雄看智力，主属性越高攻击力基础值越高。
  - **共性**：**力量**主要影响生命上限（力量越高血量越高）。**敏捷**不再通用影响攻速，攻速改由副属性**极速**影响；智力当前仅预留，后续智力英雄再扩展。
- **副属性**：**暴击**：底层为**暴击数值**，换算为暴击率：暴击率 = 暴击/(暴击+100)，如 100 暴击=50% 率、25 暴击≈20% 率；暴击时伤害 200%（2 倍）。**极速**：底层为**极速数值**，1 极速=攻速与 CD 效果+1%（100 极速=间隔与 CD 时间减半）。装备/技能可加暴击数值或极速数值，界面显示为「暴击 X (Y%)」「极速 Z (攻速/CD+Z%)」。
  - **升级成长**：每次升级时，按当前职业的成长值增加属性（如狂暴战：每级 +2 力量、+1 敏捷、+0 智力），然后按新力量重算基础生命上限，再叠加工会/装备的额外生命。
- **职业·狂暴战**（当前唯一）：大类型力量英雄；初始力 15、敏 10、智 10；每升 1 级 +2 力、+1 敏、+0 智；初始血量 800。**开局抽卡**：升级 3 选 1 仅从**初始 3 张**（狂暴姿态、激怒状态、双武器）中抽取，集齐这 3 张后才开放**基础 5 张**（嗜血、怒击、暴怒、旋风斩、斩杀）及满足前置的进阶池。**开局自带装备**：狂暴战刃（占装备栏第 1 格，+50 攻击、怒气获取 +30%，专属不可掉落）。
- **生命**：基础最大生命 = 200 + 力量×40（狂暴战 15 力即 800），可被商店「生命上限」与装备继续增加。
- **攻击**：基础攻击 = 5 + 主属性×0.2（力量英雄 15 力即 8），再 × 所有已学技能倍率 × 已激活吞噬倍率 × 商店永久加成 × 装备加成。
- **攻速**：基础攻击间隔再除以技能/吞噬/商店/装备的攻速倍率，以及**极速**（每 100 极速使攻速与 CD 速率翻倍）；敏捷不再参与攻速计算。
- **攻击范围**：以玩家为圆心、向右的半圆，半径至少覆盖游戏区上下边。
- **怒气**（仅**战士**职业，如狂暴战）：怒气上限 100。获得方式等以**三、技能系统（新·重构版）**及技能表为准（如普攻/嗜血/怒击/强化旋风斩等加怒气）。界面仅在战士时显示怒气条与数值。
- **精通**（新）：1% 精通 = 1% 伤害提升。**吸血**（新）：全局吸血，所有伤害按比例回血。**激怒状态**（新）：部分技能触发，具体效果与持续时间见技能表。
- **主动技能与被动技能**：具体技能名、效果、吞噬条件、进阶池等均以**三、技能系统（新·重构版）**及 `技能整理 - Sheet1.csv` 为准；旧版嗜血/旋风斩/暴怒描述已迁至第三节「旧技能系统」仅作对照。

### 2.2 怪物

- **刷新**：每波 20 只，按间隔 1 秒依次出现；共 20 波。
- **移动**：从右侧向左侧移动，到达玩家 x 后停下并持续攻击玩家。
- **小怪**：基础血量 100、移速 48、攻击力 1，每 1 秒对玩家造成 1 次伤害；**每波血量** = 上一波的 120%（即第 1 波 100，第 2 波 120，第 3 波 144…）。击杀获得 1 金币、5 经验。
- **Boss**：第 5、10、15、20 波的第一只为 Boss。血量 = 该波小怪血量×6，移速 = 小怪×0.7，击杀获得 5 金币、20 经验。外观为紫色大圆 +「Boss」字样。

---

## 三、技能系统（新·重构版）

**说明**：以下为与策划碰头后确定的新技能规则。实现时**旧技能全部删除**（原基础 17 张 + 5 吞噬 + 10 进阶不再使用），以新表 `技能整理 - Sheet1.csv` 为准，当前为**狂暴战专版**。

### 3.1 技能来源与分类

- **技能表**：以策划提供的 `技能整理 - Sheet1.csv` 为准（列：分类、技能名、类型、效果、前置条件、所属吞噬、专属吞噬条件、开局必出等）。
- **分类**：初始 → 基础 → 进阶 → 进阶2 → 进阶3；另有「通用」类（当前暂不做，如熟能生巧）。
- **职业**：当前仅狂暴战；技能名与效果均按表中「狂暴战」列填写。

### 3.2 抽卡小池子

- **初始 3 张**：狂暴姿态、激怒状态、双武器。开局时升级 3 选 1 **只从这 3 张里抽**，直到这 3 张都学齐（或前几次升级仅出现这 3 张，抽满为止）。
- **集齐初始 3 张之后**：**基础 5 张**（嗜血、怒击、暴怒、旋风斩、斩杀）才进入抽卡池，与后续解锁的进阶池一起参与 3 选 1。
- 技能栏位仍为最多 **7 格**；选满后可跳过或替换。

### 3.3 吞噬类型与规则（碰头结论）

| 类型 | 说明 | 实现要点 |
|------|------|----------|
| **集齐 N 张** | 如双持狂战士(3)、愤怒化身(3)、猝死+强化斩杀+毁灭(3) | 集齐即激活，组成技能不占栏位 |
| **60 秒后自动吞噬** | 旋风斩、斩杀、重伤、奥丁之怒等 | 从**学到该技能**起算，**仅战斗时间**（选技能/商店/波次间隔/暂停不计），满 60 秒吞噬 |
| **累计获得怒气** | 鲁莽 500、肆意放纵 1000 | 选到该技能后开始计**累计获得的怒气**，达到阈值吞噬；与「累计消耗怒气」分开 |
| **激怒时间累计** | 狂乱之怒等「激怒时间20秒」 | 获得技能后，**处于激怒状态的累计时间**达 20 秒吞噬 |
| **累计流血伤害** | 浴血之躯 10000 | 累计造成的流血伤害达到 10000 吞噬 |
| **获得即吞噬** | 狂怒回复、狂怒提振、生死决战 | 选到即吞噬（不占栏位、效果保留） |
| **累计消耗怒气** | 暴怒 500（沿用） | 释放暴怒累计消耗 500 怒气后吞噬 |

### 3.4 进阶池与前置条件

- **进阶池按前置条件解锁**，与「对应技能/吞噬」绑定：只有满足前置，该进阶池才会进入 3 选 1。
- 例如：**学了斩杀**才看得到斩杀进阶池（猝死、强化斩杀、毁灭）；**学了怒击**才看得到怒击进阶池；**吞噬了怒击那一组**才看得到怒击 2 进阶池（劈斩、愤与怒等）。未学/未吞噬则对应进阶池不出现。

### 3.5 新数值与机制（碰头结论）

- **精通**：1% 精通 = 1% 伤害提升（最终伤害乘 (1 + 精通%)）。
- **吸血**：全局吸血，所有造成的伤害按一定比例回血（如 3% 吸血 = 造成 100 伤害回 3 血）。
- **激怒状态**：表中嗜血 30% 进入激怒、暴怒/奥丁之怒进入激怒等；效果与持续时间以表内描述为准（如 4 秒、伤害+15%、精通+15%、吸血+3% 等），实现时与表对齐。
- **雷霆一击**：新技能，当前不做，后续补充；血肉顺劈先只做「旋风斩伤害提高 50%」。
- **熟能生巧**：先不做，不加入当前技能池。

### 3.6 当前实现状态（与代码一致）

- **技能 id**：全技能 41 条，id 0～40。0～2 初始，3～7 基础，8～40 进阶/进阶2/进阶3。战斗用常量：嗜血 id=3、怒击 id=4、暴怒 id=5、旋风斩 id=6、斩杀 id=7。
- **数据结构**：`ALL_SKILLS`（每条含 name, category, type, desc, synergyName, devourCondition, attackMul, speedMul, isActive 等）、`SYNERGY_DEFS`（13 个吞噬，各 name + req 技能 id 数组）、`ADVANCED_POOLS`（poolName, skillIds, prerequisite 或 prerequisiteSynergy）。
- **已实现**：小池子（初始 3 → 集齐后基础 5 + 进阶池）；进阶池按前置解锁；集齐类吞噬（双持狂战士、愤怒化身等）激活后组成技能不占栏位；暴怒「累计消耗 500 怒气」吞噬、旋风斩「50 击杀」吞噬；**60 秒战斗时间吞噬**（旋风斩/斩杀/重伤/奥丁之怒，仅战斗内计时）；**累计获得怒气吞噬**（鲁莽 500、肆意放纵 1000）；**激怒时间 20 秒吞噬**（狂乱之怒等，激怒状态累计时长）；**获得即吞噬**（狂怒回复、狂怒提振、生死决战）；**累计流血 10000 吞噬**（浴血之躯，状态与判断已接，实际流血伤害待重伤/流血机制）；激怒状态触发（嗜血 30%、暴怒进入激怒 4 秒）。选技能界面展示吞噬规则与所属/可激活吞噬；吞噬展示区显示其他已吞噬列表。
- **已实现（阶段五+六）**：精通、吸血在伤害/回血中生效（激怒状态时+15% 精通、+3% 吸血）；普攻/嗜血/旋风斩/暴怒/顺劈均经精通乘算与吸血回血；嗜血/怒击/旋风斩/暴怒的进阶伤害倍率（血腥疯狂、敌意、恶毒瞥视、血肉顺劈、血之气息、处决者、残酷等）与嗜血回复/怒气（寒光热血）、暴击（敌意、暴虐成性）接新表。
- **已实现（阶段七+八）**：重伤/流血 dot（主动技能命中施加重伤，6 秒内造成该次伤害 50% 的流血，每 0.2 秒跳一次，刷新叠加剩余伤害；每帧 tick，totalBleedDamage 累加，浴血之躯 +20% 流血伤害）；鲁莽主动（按钮、CD90s/持续12s、怒气+50%、暴击+20%，肆意放纵 +50 怒气及嗜血/怒击+20%）；生死决战（首次死亡复活 50% 血、一局一次）；战争印记（激怒时受伤 -10%）。
- **待实现**：其余扩展见文档末尾（装备扩展、音效、引导等）。

---

## 四、经验与升级

- 击杀小怪 +5 经验，击杀 Boss +20 经验。
- 经验满后升级：所需经验 = 10 + 当前等级×5。
- 升级时游戏暂停，弹出 3 选 1 技能（基础 + 已解锁的进阶池混合），可点「跳过」。

---

## 五、商店

- **入口**：下方面板「商店」按钮，随时可点，打开时游戏暂停。
- **货币**：金币。小怪 1 金，Boss 5 金。
- **商品**：生命药水(15)、攻击药剂(25)、极速药水(25)、生命上限(40)、大生命药水(35)。生命药水为**百分比回复**：生命药水恢复 15% 最大生命，大生命药水恢复 40% 最大生命；极速药水永久加极速+10（攻速与CD+10%）；其余为永久加攻/加生命上限。

---

## 六、装备

- **栏位**：装备栏 **6 格**，获得装备后自动填入空位，效果永久生效（与商店加成叠加）。
- **掉落**：仅**小怪**击杀时有 **1%** 概率掉落装备；Boss 不掉落。掉落时随机一件**可掉落**装备：若有空位则自动装备；若**已满**则暂停并弹出「选择替换」界面。部分装备（如职业专属）不可掉落。
- **装备列表**（10 件）：

| 名称 | 效果 | 备注 |
|------|------|------|
| 利刃 | 攻击 +10% | |
| 轻靴 | 攻速 +10% | |
| 护甲 | 生命上限 +15（并获得 15 生命） | |
| 破军刃 | 攻击 +15% | |
| 灵巧护腕 | 攻速 +12% | |
| 铁壁 | 生命上限 +25 | |
| 狂暴之握 | 攻击 +8%，攻速 +8% | |
| 疾风之靴 | 攻速 +15% | |
| 生命之种 | 攻击 +5%，生命上限 +20 | |
| 狂暴战刃 | 攻击 +50（固定）、怒气获取 +30% | **狂暴战**开局自动装备第 1 格，不可掉落 |

---

## 七、关卡与结算

- **波次**：共 20 波，每波 20 只；第 5/10/15/20 波首只为 Boss。每波结束后进入**波次间隔** 3 秒倒计时，画面中央显示「下一波」与剩余秒数，倒计时结束后开始下一波刷怪。
- **通关**：20 波全部打完且玩家存活，弹出通关界面（击杀、等级、金币、技能等），可「再来一局」。
- **失败**：玩家生命归零，弹出游戏结束界面，可「再来一局」。

---

## 八、存档与启动

- **存档**：每波结束、死亡、通关时自动写入本地（波次、等级、技能、金币、血量、装备栏、场上怪物等）；若装备栏已满且刚掉落未选替换，会保存「待替换装备」，读档后继续选择替换或放弃。
- **启动**：每次进入游戏先显示**标题界面**。无存档时仅显示「开始游戏」；有存档时显示「检测到上次进度，请选择」与「新游戏」「继续游戏」。选「新游戏」或「开始游戏」清空存档并从头开始（正确初始化起始技能与伤害统计），选「继续游戏」读取上次进度。「再来一局」会清空存档并重新开始。

---

## 九、界面与表现

- **布局**：顶部安全区（状态栏）、上半部分横条游戏区、下半部分吞噬展示 + 金币/等级/栏位/经验 + 商店按钮。
- **吞噬展示**：下方面板直接列出已激活的吞噬名称与效果。
- **装备栏**：6 格，显示已装备名称（两字缩写或全名）或「空」。满格掉落时弹出「获得装备：xxx，选择一格替换（或放弃）」覆盖层。
- **属性与英雄**：角色属性框内显示力/敏/智、大类型与职业，以及**暴击**（数值与暴击率%）、**极速**（数值与攻速/CD+%）；**战士职业**（如狂暴战）时额外显示**怒气**条与数值（当前/上限）。
- **技能栏**：7 格，格子加大以显示技能名与状态；主动技能（如嗜血）会显示 **CD Xs** / **就绪** / **攻速+**（buff 中）。
- **选技能**：升级时居中弹窗，3 张卡 + 跳过；显示栏位、可激活吞噬提示、**吞噬收集情况**（已激活的会标注「xxx ✓（技能A、技能B 已吞噬）」并说明「激活后，组成技能不占栏位，效果保留」）；若已开启进阶，显示「已开启：xx、xx 进阶卡池」，进阶卡带「xx·进阶」标签。技能卡上显示「可激活吞噬：刺客」等。
- **吞噬展示**：下方面板为**吞噬效果**区，技能栏在存在被吞噬技能时显示「（已吞噬不占位）」；每个已激活吞噬下列出「已吞噬 技能A、技能B，不占栏位」。无「套装」字样，统一用「吞噬」。
- **特效**：攻击命中/击杀有黄色扩散，受击有红色闪一下；释放主动技能（嗜血/旋风斩/暴怒）时玩家头顶短暂显示技能名（如「嗜血！」）并上飘淡出，多技能同时释放时多条文字垂直错开；音效占位已留（可后续接资源）。

---

## 十、后续可扩展（参考）

- 音效资源接入、新手引导、成就/统计、设置（音效开关）、分享等。
- 更多装备、装备从商店购买或 Boss 掉落，需同步更新本文档与代码内的常量。
- 更多波次、更多基础/进阶技能或新吞噬，需同步更新本文档与代码内的常量。

---

*文档与当前小游戏实现保持一致，有改动时请同步更新此文件。*
