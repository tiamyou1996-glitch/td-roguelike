# 塔防 Roguelike · 游戏策划与规则说明

本文档记录当前版本的核心规则与系统，便于后续扩展与交接。  
**与 AI 协作时**：新对话请先让 AI 阅读本文件与 `项目上下文.md`，以便无缝延续并记住你的约定。

---

## 一、核心玩法

- **类型**：塔防 + Roguelike，单角色站桩输出。
- **目标**：玩家站在左侧，右侧不断刷怪向左移动；玩家在攻击范围内自动普攻，击杀获得经验与金币，升级选技能，撑过 20 波并存活即通关。
- **失败**：玩家生命归零即游戏结束。

---

## 二、战斗与数值

### 2.1 玩家

- **位置**：固定于画面左侧（x=50），垂直居中于游戏区。
- **属性与英雄类型**：
  - 三种属性：**力量**、**敏捷**、**智力**。英雄**大类型**分为力量英雄、敏捷英雄、智力英雄；每个大类型下可有多个**职业**（如力量英雄下有「狂暴战」），职业决定初始属性与**升级成长**。
  - **主属性**决定攻击力：力量英雄看力量、敏捷英雄看敏捷、智力英雄看智力，主属性越高攻击力基础值越高。**力量**仅作力量系主属性（不参与生命计算）。
  - **生命**由**耐力**决定：基础最大生命 = 200 + 耐力×40；可被商店「生命上限」与装备继续增加。
  - **敏捷**不再通用影响攻速，攻速改由副属性**极速**影响；智力当前仅预留，后续智力英雄再扩展。
- **副属性**：**暴击**：底层为**暴击数值**，换算为暴击率：暴击率 = 暴击/(暴击+100)，如 100 暴击=50% 率、25 暴击≈20% 率；暴击时伤害 200%（2 倍）。**极速**：底层为**极速数值**，1 极速=攻速与 CD 效果+1%（100 极速=间隔与 CD 时间减半）。装备/技能可加暴击数值或极速数值。界面（属性弹层）中暴击显示为「暴击 率%(数值)」，极速为「极速 数值 (攻速/CD+数值%)」。
  - **升级成长**：每次升级时，按当前职业的成长值增加属性（如狂暴战：每级 +2 力、+1 敏、+0 智、+1 耐），然后按新耐力重算基础生命上限，再叠加工会/装备的额外生命。
- **职业·狂暴战**（当前唯一）：大类型力量英雄；初始力 15、敏 10、智 10、耐 15；每升 1 级 +2 力、+1 敏、+0 智、+1 耐；初始血量 800（200+15×40）。**开局抽卡**：升级 3 选 1 仅从**初始 3 张**（狂暴姿态、激怒状态、双武器）中抽取，集齐这 3 张后才开放**基础 5 张**（嗜血、怒击、暴怒、旋风斩、斩杀）及满足前置的进阶池。**开局自带装备**：狂暴战刃（占装备栏第 1 格，+50 攻击、怒气获取 +30%，专属不可掉落）。
- **攻击**：基础攻击 = 5 + 主属性×0.2（力量英雄 15 力即 8），再 × 所有已学技能倍率 × 已激活吞噬倍率 × 商店永久加成 × 装备加成。
- **攻速**：基础攻击间隔再除以技能/吞噬/商店/装备的攻速倍率，以及**极速**（每 100 极速使攻速与 CD 速率翻倍）；敏捷不再参与攻速计算。
- **攻击范围**：以玩家为圆心、向右的半圆，半径至少覆盖游戏区上下边。
- **怒气**（仅**战士**职业，如狂暴战）：怒气上限 100。获得方式等以**三、技能系统（新·重构版）**及技能表为准（如普攻/嗜血/怒击/强化旋风斩等加怒气）。界面仅在战士时显示怒气条与数值。
- **精通**（新）：1% 精通 = 1% 伤害提升。**吸血**（新）：全局吸血，所有伤害按比例回血。**激怒状态**（新）：部分技能触发，具体效果与持续时间见技能表。
- **主动技能与被动技能**：具体技能名、效果、吞噬条件、进阶池等均以**三、技能系统（新·重构版）**及 `技能整理 - Sheet1.csv` 为准；旧版嗜血/旋风斩/暴怒描述已迁至第三节「旧技能系统」仅作对照。

### 2.2 怪物

- **刷新**：每波 20 只，按间隔 1 秒依次出现；共 20 波。
- **移动**：从右侧向左侧移动，到达玩家 x 后停下并持续攻击玩家。
- **小怪**：基础血量 15、移速 48、攻击力 1，每 1 秒对玩家造成 1 次伤害。**每波血量**采用**混合公式**：1～15 波为指数 15×1.37^(wave-1)；16～20 波线性过渡，使第 20 波小怪约 5000 血（避免纯指数后期起飞）。击杀获得 1 金币、5 经验。
- **Boss**：第 5、10、15、20 波的第一只为 Boss。血量 = 该波小怪血量×6，移速 = 小怪×0.7，击杀获得 5 金币、20 经验。外观为紫色大圆 +「Boss」字样。

---

## 三、技能系统（新·重构版）

**说明**：以下为与策划碰头后确定的新技能规则。实现时**旧技能全部删除**（原基础 17 张 + 5 吞噬 + 10 进阶不再使用），以新表 `技能整理 - Sheet1.csv` 为准，当前为**狂暴战专版**。

### 3.1 技能来源与分类

- **技能表**：以策划提供的 `技能整理 - Sheet1.csv` 为准（列：分类、技能名、类型、效果、前置条件、所属吞噬、专属吞噬条件、开局必出等）。
- **分类**：初始 → 基础 → 进阶 → 进阶2 → 进阶3；另有「通用」类（当前暂不做，如熟能生巧）。
- **职业**：当前仅狂暴战；技能名与效果均按表中「狂暴战」列填写。

### 3.2 抽卡小池子

- **初始 3 张**：狂暴姿态、激怒状态、双武器。开局时升级 3 选 1 **只从这 3 张里抽**，直到这 3 张都学齐（或前几次升级仅出现这 3 张，抽满为止）。
- **集齐初始 3 张之后**：**基础 5 张**（嗜血、怒击、暴怒、旋风斩、斩杀）才进入抽卡池，与后续解锁的进阶池一起参与 3 选 1。
- 技能栏位仍为最多 **7 格**；选满后可跳过或替换。

### 3.3 吞噬类型与规则（碰头结论）

| 类型 | 说明 | 实现要点 |
|------|------|----------|
| **集齐 N 张** | 如双持狂战士(3)、愤怒化身(3)、猝死+强化斩杀+毁灭(3) | 集齐即激活，组成技能不占栏位 |
| **60 秒后自动吞噬** | 旋风斩、斩杀、重伤、奥丁之怒等 | 从**学到该技能**起算，**仅战斗时间**（选技能/商店/波次间隔/暂停不计），满 60 秒吞噬 |
| **累计获得怒气** | 鲁莽 500、肆意放纵 1000 | 选到该技能后开始计**累计获得的怒气**，达到阈值吞噬；与「累计消耗怒气」分开 |
| **激怒时间累计** | 狂乱之怒等「激怒时间20秒」 | 获得技能后，**处于激怒状态的累计时间**达 20 秒吞噬 |
| **累计流血伤害** | 浴血之躯 10000 | 累计造成的流血伤害达到 10000 吞噬 |
| **获得即吞噬** | 狂怒回复、狂怒提振、生死决战 | 选到即吞噬（不占栏位、效果保留） |
| **累计消耗怒气** | 暴怒 500（沿用） | 释放暴怒累计消耗 500 怒气后吞噬 |

### 3.4 进阶池与前置条件

- **进阶池按前置条件解锁**，与「对应技能/吞噬」绑定：只有满足前置，该进阶池才会进入 3 选 1。
- 例如：**学了斩杀**才看得到斩杀进阶池（猝死、强化斩杀、毁灭）；**学了怒击**才看得到怒击进阶池；**吞噬了怒击那一组**才看得到怒击 2 进阶池（劈斩、愤与怒等）。未学/未吞噬则对应进阶池不出现。

### 3.5 新数值与机制（碰头结论）

- **精通**：1% 精通 = 1% 伤害提升（最终伤害乘 (1 + 精通%)）。
- **吸血**：全局吸血，所有造成的伤害按一定比例回血（如 3% 吸血 = 造成 100 伤害回 3 血）。
- **激怒状态**：表中嗜血 30% 进入激怒、暴怒/奥丁之怒进入激怒等；效果与持续时间以表内描述为准（如 4 秒、伤害+15%、精通+15%、吸血+3% 等），实现时与表对齐。
- **雷霆一击**：新技能，当前不做，后续补充；血肉顺劈先只做「旋风斩伤害提高 50%」。
- **熟能生巧**：先不做，不加入当前技能池。

### 3.6 当前实现状态（与代码一致）

- **技能 id**：全技能 41 条，id 0～40。0～2 初始，3～7 基础，8～40 进阶/进阶2/进阶3。战斗用常量：嗜血 id=3、怒击 id=4、暴怒 id=5、旋风斩 id=6、斩杀 id=7。
- **数据结构**：`ALL_SKILLS`（每条含 name, category, type, desc, synergyName, devourCondition, attackMul, speedMul, isActive 等）、`SYNERGY_DEFS`（13 个吞噬，各 name + req 技能 id 数组）、`ADVANCED_POOLS`（poolName, skillIds, prerequisite 或 prerequisiteSynergy）。
- **已实现**：小池子（初始 3 → 集齐后基础 5 + 进阶池）；进阶池按前置解锁；集齐类吞噬（双持狂战士、愤怒化身等）激活后组成技能不占栏位；暴怒「累计消耗 500 怒气」吞噬、旋风斩「50 击杀」吞噬（选到该技能后才计数）；**60 秒战斗时间吞噬**（旋风斩/斩杀/重伤/奥丁之怒，仅战斗内计时）；**累计获得怒气吞噬**（鲁莽 500、肆意放纵 1000）；**激怒时间 20 秒吞噬**（狂乱之怒等，激怒状态累计时长）；**获得即吞噬**（狂怒回复、狂怒提振、生死决战）；**累计流血 10000 吞噬**（浴血之躯，状态与判断已接，实际流血伤害待重伤/流血机制）；激怒状态触发（嗜血 30%、暴怒进入激怒 4 秒）。选技能界面展示吞噬规则与所属/可激活吞噬；吞噬展示区显示其他已吞噬列表。
- **已实现（阶段五+六）**：精通、吸血在伤害/回血中生效（激怒状态时+15% 精通、+3% 吸血）；普攻/嗜血/旋风斩/暴怒/顺劈均经精通乘算与吸血回血；嗜血/怒击/旋风斩/暴怒的进阶伤害倍率（血腥疯狂、敌意、恶毒瞥视、血肉顺劈、血之气息、处决者、残酷等）与嗜血回复/怒气（寒光热血）、暴击（敌意、暴虐成性）接新表。
- **已实现（阶段七+八）**：重伤/流血 dot（主动技能命中施加重伤，6 秒内造成该次伤害 50% 的流血，每 0.2 秒跳一次，刷新叠加剩余伤害；每帧 tick，totalBleedDamage 累加，浴血之躯 +20% 流血伤害）；鲁莽主动（按钮、CD90s/持续12s、怒气+50%、暴击+20%，肆意放纵 +50 怒气及嗜血/怒击+20%）；生死决战（首次死亡复活 50% 血、一局一次）；战争印记（激怒时受伤 -10%）。
- **待实现**：其余扩展见文档末尾（装备扩展、音效、引导等）。

---

## 四、经验与升级

- 击杀小怪 +5 经验，击杀 Boss +20 经验。
- 经验满后升级：所需经验 = 10 + 当前等级×5。
- 升级时游戏暂停，弹出 3 选 1 技能（基础 + 已解锁的进阶池混合），可点「跳过」。

---

## 五、商店

- **入口**：底部 TAB 栏「商店」，点击后抽屉升起，随时可打开。
- **货币**：金币。小怪 1 金，Boss 5 金；**挑战成功**第 1 次 20 金，之后每次 ×1.5（30、45…）。
- **商品**：仅两项。① **生命药水**：15 金，恢复 15% 最大生命。② **打磨武器**：价格动态，底价 10 金，每次购买后下次价格 ×1.5；效果为**武器属性 +20%**（装备的 strBonus/staBonus/attackFlat 均乘 weaponForgedMul，即力量、耐力、攻击来自装备的部分每次 +20%）；打磨后耐力增加会重算最大生命。新增武器时，打磨需对该武器的所有属性字段生效（见项目上下文「武器属性与打磨/升级」）。

---

## 六、装备

- **栏位**：装备栏 **1 格**。当前仅一件装备「**两把双手剑**」：力量 +10、耐力 +10、攻击 +20；效果受**打磨武器**乘数（weaponForgedMul）影响，装备栏与属性面板显示打磨后数值。
- **获取**：**集齐初始 3 张技能**（狂暴姿态、激怒状态、双武器）激活「双持狂战士」吞噬后，**自动发放**两把双手剑，无需掉落。发放时会有明显提示动画（中央弹窗「你获得了一把新武器！」后缩小飞入装备栏）。
- **怪物不掉落装备**；装备逻辑扩展时再增加栏位与掉落，需同步更新本文档与 `项目上下文.md`「武器属性与打磨/升级」。

---

## 七、关卡与结算

- **波次**：共 20 波，每波 20 只；第 5/10/15/20 波首只为 Boss。每波结束后进入**波次间隔** 3 秒倒计时，画面中央显示「下一波」与剩余秒数，倒计时结束后开始下一波刷怪。
- **主动挑战**：底部 TAB「挑战」抽屉内可点击「开始挑战」。**在屏幕正中央**出现一只**挑战 Boss**（头顶「挑战」），限时 **30 秒**；击杀则挑战成功，超时则失败。第 1 层 Boss 血量 = 第 5 波 Boss 的 50%，攻击同普通 Boss；之后每层 Boss 血量与攻击**翻倍**。**奖励**：挑战成功第 1 次 **100 金币**，之后每次奖励 ×1.5（第 2 次 150、第 3 次 225…）。
- **通关**：20 波全部打完且玩家存活，弹出通关界面（击杀、等级、金币、技能等），可「再来一局」。
- **失败**：玩家生命归零，弹出游戏结束界面，可「再来一局」。

---

## 八、存档与启动

- **存档**：每波结束、死亡、通关时自动写入本地（波次、等级、技能、金币、血量、装备栏、场上怪物等）；若装备栏已满且刚掉落未选替换，会保存「待替换装备」，读档后继续选择替换或放弃。
- **启动**：每次进入游戏先显示**标题界面**。无存档时仅显示「开始游戏」；有存档时显示「检测到上次进度，请选择」与「新游戏」「继续游戏」。选「新游戏」或「开始游戏」清空存档并从头开始（正确初始化起始技能与伤害统计），选「继续游戏」读取上次进度。「再来一局」会清空存档并重新开始。

---

## 九、界面与表现

- **布局**：顶部安全区、上半部分游戏区、下半部分为**底部 TAB 栏**（挑战、属性、伤害统计、吞噬效果、商店）+ 点击后升起的**抽屉**。游戏区内玩家血条/怒气条固定于顶部，怪物血条在单位上方，重叠时错开显示。
- **TAB 与抽屉**：点击 TAB 升起对应内容抽屉（挑战说明+开始挑战、角色属性、伤害统计、吞噬效果、商店列表）；再次点击同一 TAB 或点击其他 TAB 可收起/切换。伤害统计内容过多时支持在抽屉内上下拖动滚动。
- **属性/伤害统计/吞噬效果**：均在对应抽屉内展示。属性为两列：生命值、攻击力、攻速、攻击间隔（及永久加成）；力量、敏捷、智力、耐力、暴击、极速、精通、吸血、怒气、职业。数值取整显示（生命值、力量、耐力等）。
- **装备栏**：1 格，显示装备名与打磨后效果（如「力量+12 耐力+12 攻击+24」）。集齐 3 个初始技能后自动获得「两把双手剑」，并播放获得武器提示动画（弹窗缩小飞入装备栏）。
- **技能栏**：6 格（2 行×3），显示技能名与状态；存在被吞噬技能时显示「（已吞噬不占位）」；文字做裁剪防溢出。
- **选技能**：升级时 3 选 1；旋风斩「50 击杀」吞噬进度为**选到该技能之后**的击杀数。集齐初始 3 张后发放武器并提示。
- **音效**：命中/击杀/升级/购买/受伤使用 **Web Audio API 程序化音效**（无需外部文件）；也可在 `audio/` 下放置 mp3 后扩展。

---

## 十、后续可扩展（参考）

- 音效文件（audio/*.mp3）替换或补充程序化音效、新手引导、成就/统计、设置（音效开关）、分享等。
- 更多装备、装备栏位与掉落，需同步更新本文档与 `项目上下文.md`「武器属性与打磨/升级」。
- 更多波次、技能或吞噬，需同步更新本文档与代码常量。

---

*文档与当前小游戏实现保持一致，有改动时请同步更新此文件。*
