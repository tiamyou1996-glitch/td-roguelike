# 技能链条 · 实现清单

按我们讨论的「专精 → 经典狂暴战阶段 → 钥匙卡 + 展开技能」设计，当前代码里**已做**和**未做**的对照。未做的部分需要你确认后再开工实现。

---

## 一、已实现

| 项 | 说明 |
|----|------|
| 愤怒化身 = 4 张 | 集齐 嗜血、怒击、暴怒、旋风斩 后吞噬；`SYNERGY_DEFS` 愤怒化身 `req: [3,4,5,6]`；嗜血/怒击/暴怒/旋风斩的 `devourCondition` 与展示已更新。 |
| 暴怒单独吞噬 | 暴怒仍保留「累计消耗 500 怒气」吞噬，与「集齐四张」满足其一即不占栏位。 |
| 各线技能吞噬规则 | 暴怒线（集齐/激怒 20s）、嗜血线（集齐/60s/流血 10000）、怒击线（集齐）等，与现有 `SYNERGY_DEFS`、`isSkillConsumedBySynergy` 等逻辑一致，无需改。 |

---

## 二、已实现（本次实现）

### 1. 经典狂暴战阶段

- **实现**：不单独存状态，由「愤怒化身是否激活」推导：`isClassicFuryPoolActive()` = `isSynergyActiveByName('愤怒化身')`。当为 true 时，`fillSkillChoices()` 走经典狂暴战池子逻辑。

### 2. 钥匙卡（3 张顶层 + 线内）

- **实现**：钥匙卡 id 100～106（常量 `KEY_BAONU` 等），`CLASSIC_FURY_LINES` 定义三条线每层的 keyCardId、keyName、skillIds、synergyName。选到钥匙卡只写入 `pickedKeyCardIds`，不加入 `learned_skill_ids`，不占栏位、无战斗效果。

### 3. 线内下一张钥匙卡进池

- **实现**：`buildClassicFuryPool()` 中，对每条线每一层：若上一层的钥匙卡已选且上一层吞噬已激活，则本层钥匙卡加入候选池；若本层钥匙卡已选，则本层 skillIds 中未学的技能加入候选池。

### 4. 抽卡池在经典狂暴战下的规则

- **实现**：`fillSkillChoices()` 在 `isClassicFuryPoolActive()` 时调用 `buildClassicFuryPool()`，池子 = 顶层未选钥匙卡 + 各线已选钥匙卡展开的当前层未学技能 + 本层吞噬后下一张钥匙卡（未选时）。从候选池随机抽最多 3 张。

### 5. 存档与重置

- **实现**：`pickedKeyCardIds` 已加入存档、读档与 `resetGame()`。

### 6. 选技能 UI

- **实现**：选技能界面中，若选项为钥匙卡 id，则显示「钥匙卡」标签、`getKeyCardDisplayName(id)`、`getKeyCardDesc(id)`（打开XX技能链），不显示吞噬规则等。

---

## 三、小结

| 类别         | 状态   |
|--------------|--------|
| 愤怒化身 4 张 | ✓ 已实现 |
| 经典狂暴战阶段（由愤怒化身推导） | ✓ 已实现 |
| 钥匙卡（3 张顶层 + 线内） | ✓ 已实现 |
| 池子 = 钥匙卡 + 已展开技能 + 吞噬后下一钥匙 | ✓ 已实现 |
| 存档/重置 pickedKeyCardIds | ✓ 已实现 |
| 选技能 UI 展示钥匙卡 | ✓ 已实现 |
